{"version":3,"file":"engineInstrumentation.js","sourceRoot":"","sources":["../../../sourceES6/core/Instrumentation/engineInstrumentation.ts"],"names":[],"mappings":"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","sourcesContent":["import { Observer } from \"../Misc/observable\";\r\nimport { PerfCounter } from \"../Misc/perfCounter\";\r\nimport { Nullable } from \"../types\";\r\nimport { IDisposable } from \"../scene\";\r\nimport { Engine } from \"../Engines/engine\";\r\nimport { _TimeToken } from \"../Instrumentation/timeToken\";\r\n/**\r\n * This class can be used to get instrumentation data from a Babylon engine\r\n * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#engineinstrumentation\r\n */\r\nexport class EngineInstrumentation implements IDisposable {\r\n    private _captureGPUFrameTime = false;\r\n    private _gpuFrameTimeToken: Nullable<_TimeToken>;\r\n    private _gpuFrameTime = new PerfCounter();\r\n\r\n    private _captureShaderCompilationTime = false;\r\n    private _shaderCompilationTime = new PerfCounter();\r\n\r\n    // Observers\r\n    private _onBeginFrameObserver: Nullable<Observer<Engine>> = null;\r\n    private _onEndFrameObserver: Nullable<Observer<Engine>> = null;\r\n    private _onBeforeShaderCompilationObserver: Nullable<Observer<Engine>> = null;\r\n    private _onAfterShaderCompilationObserver: Nullable<Observer<Engine>> = null;\r\n\r\n    // Properties\r\n    /**\r\n     * Gets the perf counter used for GPU frame time\r\n     */\r\n    public get gpuFrameTimeCounter(): PerfCounter {\r\n        return this._gpuFrameTime;\r\n    }\r\n\r\n    /**\r\n     * Gets the GPU frame time capture status\r\n     */\r\n    public get captureGPUFrameTime(): boolean {\r\n        return this._captureGPUFrameTime;\r\n    }\r\n\r\n    /**\r\n     * Enable or disable the GPU frame time capture\r\n     */\r\n    public set captureGPUFrameTime(value: boolean) {\r\n        if (value === this._captureGPUFrameTime) {\r\n            return;\r\n        }\r\n\r\n        this._captureGPUFrameTime = value;\r\n\r\n        if (value) {\r\n            this._onBeginFrameObserver = this.engine.onBeginFrameObservable.add(() => {\r\n                if (!this._gpuFrameTimeToken) {\r\n                    this._gpuFrameTimeToken = this.engine.startTimeQuery();\r\n                }\r\n            });\r\n\r\n            this._onEndFrameObserver = this.engine.onEndFrameObservable.add(() => {\r\n                if (!this._gpuFrameTimeToken) {\r\n                    return;\r\n                }\r\n                let time = this.engine.endTimeQuery(this._gpuFrameTimeToken);\r\n\r\n                if (time > -1) {\r\n                    this._gpuFrameTimeToken = null;\r\n                    this._gpuFrameTime.fetchNewFrame();\r\n                    this._gpuFrameTime.addCount(time, true);\r\n                }\r\n            });\r\n        } else {\r\n            this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver);\r\n            this._onBeginFrameObserver = null;\r\n            this.engine.onEndFrameObservable.remove(this._onEndFrameObserver);\r\n            this._onEndFrameObserver = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the perf counter used for shader compilation time\r\n     */\r\n    public get shaderCompilationTimeCounter(): PerfCounter {\r\n        return this._shaderCompilationTime;\r\n    }\r\n\r\n    /**\r\n     * Gets the shader compilation time capture status\r\n     */\r\n    public get captureShaderCompilationTime(): boolean {\r\n        return this._captureShaderCompilationTime;\r\n    }\r\n\r\n    /**\r\n     * Enable or disable the shader compilation time capture\r\n     */\r\n    public set captureShaderCompilationTime(value: boolean) {\r\n        if (value === this._captureShaderCompilationTime) {\r\n            return;\r\n        }\r\n\r\n        this._captureShaderCompilationTime = value;\r\n\r\n        if (value) {\r\n            this._onBeforeShaderCompilationObserver = this.engine.onBeforeShaderCompilationObservable.add(() => {\r\n                this._shaderCompilationTime.fetchNewFrame();\r\n                this._shaderCompilationTime.beginMonitoring();\r\n            });\r\n\r\n            this._onAfterShaderCompilationObserver = this.engine.onAfterShaderCompilationObservable.add(() => {\r\n                this._shaderCompilationTime.endMonitoring();\r\n            });\r\n        } else {\r\n            this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver);\r\n            this._onBeforeShaderCompilationObserver = null;\r\n            this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver);\r\n            this._onAfterShaderCompilationObserver = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Instantiates a new engine instrumentation.\r\n     * This class can be used to get instrumentation data from a Babylon engine\r\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#engineinstrumentation\r\n     * @param engine Defines the engine to instrument\r\n     */\r\n    public constructor(\r\n        /**\r\n         * Define the instrumented engine.\r\n         */\r\n        public engine: Engine) {\r\n    }\r\n\r\n    /**\r\n     * Dispose and release associated resources.\r\n     */\r\n    public dispose() {\r\n        this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver);\r\n        this._onBeginFrameObserver = null;\r\n\r\n        this.engine.onEndFrameObservable.remove(this._onEndFrameObserver);\r\n        this._onEndFrameObserver = null;\r\n\r\n        this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver);\r\n        this._onBeforeShaderCompilationObserver = null;\r\n\r\n        this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver);\r\n        this._onAfterShaderCompilationObserver = null;\r\n\r\n        (<any>this.engine) = null;\r\n    }\r\n}\r\n"]}