{"version":3,"file":"KHR_materials_sheen.js","sourceRoot":"","sources":["../../../../../sourceES6/serializers/src/glTF/2.0/Extensions/KHR_materials_sheen.ts"],"names":[],"mappings":"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","sourcesContent":["import { ITextureInfo, IMaterial } from \"babylonjs-gltf2interface\";\r\nimport { IGLTFExporterExtensionV2 } from \"../glTFExporterExtension\";\r\nimport { _Exporter } from \"../glTFExporter\";\r\nimport { Material } from '@babylonjs/core/Materials/material';\r\nimport { PBRMaterial } from '@babylonjs/core/Materials/PBR/pbrMaterial';\r\nimport { Texture } from '@babylonjs/core/Materials/Textures/texture';\r\nimport { BaseTexture } from '@babylonjs/core/Materials/Textures/baseTexture';\r\nimport { Nullable } from '@babylonjs/core/types';\r\nimport { IKHRMaterialsSheen } from 'babylonjs-gltf2interface';\r\n\r\nconst NAME = \"KHR_materials_sheen\";\r\n\r\n/**\r\n * @hidden\r\n */\r\nexport class KHR_materials_sheen implements IGLTFExporterExtensionV2 {\r\n    /** Name of this extension */\r\n    public readonly name = NAME;\r\n\r\n    /** Defines whether this extension is enabled */\r\n    public enabled = true;\r\n\r\n    /** Defines whether this extension is required */\r\n    public required = false;\r\n\r\n    /** Reference to the glTF exporter */\r\n    private _textureInfos: ITextureInfo[] = [];\r\n    private _exportedTextures: Nullable<BaseTexture>[] = [];\r\n\r\n    private _wasUsed = false;\r\n\r\n    constructor(exporter: _Exporter) {\r\n    }\r\n\r\n    public dispose() {\r\n       this._textureInfos = [];\r\n       this._exportedTextures = [];\r\n    }\r\n\r\n    /** @hidden */\r\n    public get wasUsed() {\r\n        return this._wasUsed;\r\n    }\r\n\r\n    private _getTextureIndex(babylonTexture: BaseTexture) {\r\n        let textureIndex = this._exportedTextures.indexOf(babylonTexture);\r\n\r\n        if (textureIndex === -1 && babylonTexture.reservedDataStore) {\r\n            textureIndex = this._exportedTextures.indexOf(babylonTexture.reservedDataStore.source);\r\n        }\r\n\r\n        return textureIndex;\r\n    }\r\n\r\n    public postExportTexture?(context: string, textureInfo: ITextureInfo, babylonTexture: Texture): void {\r\n        let textureIndex = this._getTextureIndex(babylonTexture);\r\n\r\n        if (textureIndex > -1) {\r\n            this._textureInfos[textureIndex] = textureInfo;\r\n        }\r\n    }\r\n\r\n    public postExportMaterialAdditionalTextures?(context: string, node: IMaterial, babylonMaterial: Material): BaseTexture[] {\r\n        if (babylonMaterial instanceof PBRMaterial) {\r\n            if (babylonMaterial.sheen.isEnabled && babylonMaterial.sheen.texture) {\r\n                this._exportedTextures.push(babylonMaterial.sheen.texture);\r\n                return [babylonMaterial.sheen.texture];\r\n            }\r\n        }\r\n\r\n        return [];\r\n    }\r\n\r\n    public postExportMaterialAsync?(context: string, node: IMaterial, babylonMaterial: Material): Promise<IMaterial> {\r\n        return new Promise((resolve, reject) => {\r\n            if (babylonMaterial instanceof PBRMaterial) {\r\n                if (!babylonMaterial.sheen.isEnabled) {\r\n                    resolve(node);\r\n                    return;\r\n                }\r\n\r\n                this._wasUsed = true;\r\n\r\n                if (node.extensions == null) {\r\n                    node.extensions = {};\r\n                }\r\n                const sheenInfo: IKHRMaterialsSheen = {\r\n                    sheenColorFactor: babylonMaterial.sheen.color.asArray(),\r\n                    sheenRoughnessFactor: babylonMaterial.sheen.roughness ?? 0\r\n                };\r\n\r\n                if (babylonMaterial.sheen.texture) {\r\n                    let textureIndex = this._getTextureIndex(babylonMaterial.sheen.texture);\r\n\r\n                    if (textureIndex > -1) {\r\n                        sheenInfo.sheenColorTexture = this._textureInfos[textureIndex];\r\n                    }\r\n                }\r\n\r\n                if (babylonMaterial.sheen.textureRoughness && !babylonMaterial.sheen.useRoughnessFromMainTexture) {\r\n                    let textureIndex = this._getTextureIndex(babylonMaterial.sheen.textureRoughness);\r\n\r\n                    if (textureIndex > -1) {\r\n                        sheenInfo.sheenRoughnessTexture = this._textureInfos[textureIndex];\r\n                    }\r\n                } else if (babylonMaterial.sheen.texture && babylonMaterial.sheen.useRoughnessFromMainTexture) {\r\n                    let textureIndex = this._getTextureIndex(babylonMaterial.sheen.texture);\r\n\r\n                    if (textureIndex > -1) {\r\n                        sheenInfo.sheenRoughnessTexture = this._textureInfos[textureIndex];\r\n                    }\r\n                }\r\n\r\n                node.extensions[NAME] = sheenInfo;\r\n            }\r\n            resolve(node);\r\n        });\r\n    }\r\n}\r\n\r\n_Exporter.RegisterExtension(NAME, (exporter) => new KHR_materials_sheen(exporter));"]}